# 対話リトライ判定ロジック仕様書

本ドキュメントは、Duo-Talk システムにおける AI キャラクターの発言評価およびリトライ（再生成）判定の仕組みを解説します。Gemma2-27b での過敏検出や口調マーカー誤認を抑えるため、ハードルールを二段階化し、口調判定を多信号化します。

## 1. 評価プロセスの概要

キャラクター（やな・あゆ）が発言を生成した後、**Director（ディレクター）** がその内容を多角的に検証します。評価結果には以下の4つのステータスがあります。

- **PASS**: 合格。そのまま表示されます。
- **WARN**: 重大ではない不備。発言は表示し、次回指示（介入）で修正します。
- **RETRY**: 不合格。理由と改善案を添えて、AI に再生成を命じます。
- **MODIFY**: 概ね合格だが、軽微な修正が必要（内部処理用）。

## 2. 評価前処理（正規化）

判定前に文字列を正規化し、誤検出を抑制します。

1. **引用・台本除外**
   - 「」および（）内のテキストは**口調マーカー判定と褒め言葉判定から除外**します。
   - 例: 「すごいね」は口調・褒め言葉判定に含めない。
2. **記号正規化**
   - 連続する記号は1つに畳み込みます（例: `！！` → `！`）。
   - 句読点の揺れを統一します（例: `｡` → `。`）。
3. **空白正規化**
   - 連続空白は1つに畳み込みます。

## 3. 確定的なチェック（ハードルール）

コードによって強制的に判定される項目です。**RETRY と WARN を明確に分けて過敏検出を抑えます。**

| 項目 | 内容 | 判定基準 | 備考 |
| :--- | :--- | :--- | :--- |
| **出力形式** | 文字数や改行の制限 | **8行以上**で `RETRY`、**6〜7行**で `WARN`。 | 5行までは許容。 |
| **設定整合性** | 基本設定の維持 | 「別居している」「一人暮らし」など、姉妹が一緒に住んでいないかのような表現で `RETRY`。 | 明確な設定破綻は即 `RETRY`。 |
| **褒め言葉** | サービス精神の抑制 | **評価語 + 相手への肯定**が同一文中にある場合 `RETRY`。単独の評価語は `WARN`。 | あゆは情報提供役に徹するため。 |
| **散漫検出** | 応答の絞り込み | **4文以上かつ話題が3つ以上**で `RETRY`。**3文**または**話題2つ**は `WARN`。 | 50〜80文字以内を推奨。 |
| **論理矛盾** | 意味の整合性 | 二重否定で意図が逆転している表現は `RETRY`。 | 例:「まだ未成年じゃない」。 |
| **口調マーカー** | キャラクター性 | 口調スコアが **0** で `RETRY`、**1** で `WARN`。 | 口調スコアは §4 参照。 |

## 4. 口調マーカーの多信号判定

口調の誤認を避けるため、**語尾・語彙・文体**の複合スコアで判定します。

### 4.1 口調スコア定義

- `tone_score = marker_hit + vocab_hit + style_hit`
- `tone_score >= 2` → PASS
- `tone_score == 1` → WARN
- `tone_score == 0` → RETRY

### 4.2 語尾マーカー（marker_hit）

**正規化済み本文**で以下の語尾が1つでも含まれる場合に `marker_hit = 1`。

- **やな**: `わ！` / `へ？` / `よね` / `かな` / `かも`
- **あゆ**: `でしょう` / `ですね` / `ました` / `ません`

### 4.3 語彙マーカー（vocab_hit）

キャラ固有の語彙や、文末以外の特徴的な単語が1つでも含まれる場合に `vocab_hit = 1`。

- **やな**: `やだ` / `ほんと` / `えー` / `うーん` / `すっごい` / `そっか` / `だね` / `ね。`
- **あゆ**: `つまり` / `要するに` / `一般的に` / `目安` / `推奨` / `ですよ` / `です。`

### 4.4 文体マーカー（style_hit）

文体の特徴を満たした場合に `style_hit = 1`。

- **やな**: 2文以下かつ感嘆符（`！`または`？`）を含む
- **あゆ**: 文末に丁寧語（`です/ます/でした/ました`）が**2回以上**出現

## 5. 褒め言葉判定の詳細

### 5.1 評価語リスト

評価語（例）: `すごい` / `素晴らしい` / `正解` / `完璧` / `天才`

### 5.2 判定条件

以下の両条件を満たす場合に `RETRY`。

- 評価語が含まれる
- **相手への肯定**が同文内にある
  - 例: `あなた/きみ/ユーザー/その答え/その考え` + `正しい/合っている/素敵` など

評価語のみの場合は `WARN` に留める。

## 6. 散漫検出の詳細

### 6.1 文数カウント

- `。` / `！` / `？` を文末記号として文数をカウントします。
- 句点なしで改行された場合は改行も文末として扱います。

### 6.2 話題数の推定

- 「〜について（です/した/話など）」「〜の話」「（名詞）は（活用語）」などのパターンを話題境界として数えます。
- 3つ以上の話題境界があれば「話題3つ以上」と判定。

## 7. LLMによる総合評価（確率的チェック）

ハードルールをクリアした後、Director LLM が以下の5つの観点で最終判定を行います。

1. **フレーム整合性**: その場の状況（景色や場所）に合った内容か。
2. **ロールプレイ**: 姉妹の関係性、性格が守られているか。
3. **対話の接続性**: 直前の相手の発言を無視していないか。
4. **情報密度**: 内容が薄すぎないか、または詰め込みすぎていないか。
5. **自然さ**: 機械的な繰り返しや、唐突な表現がないか。

### 7.1 スコア判定

Gemma2-27b の過敏判定を抑えるため、**数値スコア制**を採用します。

- 各観点を 1〜5 点で評価
- 総合スコア = 5観点の平均

判定基準:

- **平均 < 3.5** → `RETRY`
- **3.5 〜 3.9** → `WARN`
- **4.0 以上** → `PASS`

## 8. 特殊なケース（警告・介入）

以下のケースは `RETRY` 対象ではなく、**PASS/WARN のまま次回介入で修正**します。

- **「」の使用（台本形式）**: 発言が「」で囲まれていても内容に問題がなければ続行。
- **話題ループ**: 同じ単語を何度も繰り返している場合は `WARN`。
- **早すぎる話題転換**: 現在の話題を十分に掘り下げていない段階で別の話を始めた場合は `WARN`。

## 9. 状態管理の安全性

リトライ（`RETRY`）と判定された発言は、**システムの内部状態を更新しません。**

- 話題の進行度（Hook Depth）は進みません。
- ループ検知のカウントも増えません。

これにより、失敗した発言の影響で「話題が早すぎる」と誤判定されることがなくなりました。
