# 対話リトライ判定ロジック仕様書

本ドキュメントは、Duo-Talk システムにおける AI キャラクターの発言評価およびリトライ（再生成）判定の仕組みを解説します。

## 1. 評価プロセスの概要

キャラクター（やな・あゆ）が発言を生成した後、**Director（ディレクター）** がその内容を多角的に検証します。評価結果には以下の3つのステータスがあります。

- **PASS**: 合格。そのまま表示されます。
- **RETRY**: 不合格。理由と改善案を添えて、AI に再生成を命じます。
- **MODIFY**: 概ね合格だが、軽微な修正が必要（内部処理用）。

## 2. 確定的なチェック（ハードルール）

コードによって強制的に `RETRY` と判定される項目です。

| 項目 | 内容 | 判定基準 | 備考 |
| :--- | :--- | :--- | :--- |
| **出力形式** | 文字数や改行の制限 | **6行以上**の改行がある場合。 | 5行までは「警告」として許容されます。 |
| **設定整合性** | 基本設定の維持 | 「別居している」「一人暮らし」など、姉妹が一緒に住んでいないかのような表現。 | |
| **褒め言葉** | サービス精神の抑制 | あゆ（妹）が「すごい」「素晴らしい」「正解」などの評価的な言葉を使うこと。 | あゆは情報提供役に徹するため。 |
| **散漫検出** | 応答の絞り込み | 話題が多すぎる、または1つの応答で3文以上（目安）ある場合。 | 50〜80文字以内を推奨。 |
| **論理矛盾** | 意味の整合性 | 「まだ未成年じゃない」などの二重否定で、意図が逆転している表現。 | |
| **口調マーカー** | キャラクター性 | 各キャラ固有の語尾や感動詞が**1つも含まれていない**場合。 | **やな**: ね、わ！、へ？ 等<br>**あゆ**: です、ます 等 |

## 3. LLMによる総合評価（確率的なチェック）

ハードルールをクリアした後、Director LLM が以下の5つの観点で最終判定を行います。

1.  **フレーム整合性**: その場の状況（景色や場所）に合った内容か。
2.  **ロールプレイ**: 姉妹の関係性、性格が守られているか。
3.  **対話の接続性**: 直前の相手の発言を無視していないか。
4.  **情報密度**: 内容が薄すぎないか、または詰め込みすぎていないか。
5.  **自然さ**: 機械的な繰り返しや、唐突な表現がないか。

## 4. 特殊なケース（警告・介入）

以下のケースは、かつては `RETRY` 対象でしたが、現在は柔軟な運用のため **`RETRY` にはせず、PASS させた上で次回の指示（介入）で修正を図る**ように変更されました。

- **「」の使用（台本形式）**: 発言が「」で囲まれていても、内容に問題がなければ続行します。
- **話題ループ**: 同じ単語を何度も繰り返している場合、リトライはせず「別の話題に変えて」という指示を出します。
- **早すぎる話題転換**: 現在の話題を十分に掘り下げていない段階で別の話を始めた場合、リトライはせず「今の話題をもう少し続けて」と介入します。

## 5. 状態管理の安全性

リトライ（`RETRY`）と判定された発言は、**システムの内部状態を更新しません。**
- 話題の進行度（Hook Depth）は進みません。
- ループ検知のカウントも増えません。

これにより、失敗した発言の影響で「話題が早すぎる」と誤判定されることがなくなりました。
