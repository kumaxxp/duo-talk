# duo-talk 将来構想

未実装の機能設計。優先度順に記載。

---

## 1. オーナー介入機能

### 1.1 概要

対話が横道にそれた際に、オーナー（ユーザー）が介入してディレクターを通じて軌道修正できる機能。

### 1.2 ユースケース

| ケース | 状況 | オーナーの介入 |
|--------|------|---------------|
| 話題逸脱 | カーブの話をしていたのにセンサーの話へ | 「カーブの話に戻して」 |
| 深掘り要求 | 面白い話題が出たので掘り下げたい | 「今の〇〇についてもっと話して」 |
| 情報補足 | キャラクターが知らない情報を追加 | 「実は昨日のログでは△△だった」 |
| 雰囲気変更 | 真面目すぎる/ふざけすぎ | 「もう少しリラックスして」 |
| 特定キャラ指名 | 特定のキャラに話させたい | 「あゆの見解を聞きたい」 |

### 1.3 設計原則

| 原則 | 内容 |
|------|------|
| 自然な流れ | オーナー指示を「台本の指示」として自然に反映 |
| キャラ維持 | 介入後もキャラクター性を保つ |
| 双方向性 | キャラクターからオーナーへの逆質問を許容 |
| 最小介入 | 必要最小限の介入で効果を出す |

### 1.4 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                   オーナー介入システム                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【通常状態: RUNNING】                                          │
│   ┌─────────┐        ┌─────────┐                              │
│   │  やな   │ ←────→ │  あゆ   │                              │
│   └─────────┘        └─────────┘                              │
│        ↑                  ↑                                    │
│        └──────────────────┘                                    │
│                 │                                               │
│        ┌────────┴────────┐                                     │
│        │    Director     │                                     │
│        └─────────────────┘                                     │
│                                                                 │
│  【介入状態: INTERVENTION】                                     │
│                                                                 │
│        ┌─────────────────┐                                     │
│        │     Owner       │ ← 介入入力                          │
│        └────────┬────────┘                                     │
│                 │                                               │
│                 ▼                                               │
│        ┌─────────────────┐                                     │
│        │  Intervention   │                                     │
│        │   Processor     │                                     │
│        └────────┬────────┘                                     │
│                 │                                               │
│                 ▼                                               │
│        ┌─────────────────┐                                     │
│        │    Director     │ ← 指示を解釈して次の発話を決定      │
│        └─────────────────┘                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 1.5 実装予定

- `src/intervention.py` - 介入処理
- `src/intervention_parser.py` - 介入指示の解析
- GUI: 介入入力パネル

---

## 2. 姉妹記憶システム

### 2.1 概要

やなとあゆが過去の体験を「姉妹それぞれの視点」で記憶し、会話に自然に反映させるシステム。

### 2.2 設計原則

| 原則 | 内容 | 理由 |
|------|------|------|
| 読み出し優先 | 走行中は検索のみ | レイテンシ確保 |
| バッチ書き込み | 終了後にまとめて保存 | I/O負荷軽減 |
| キャラ崩壊防止 | 保存前フィルタ必須 | 視点の逆転防止 |
| 視点分離 | 同じ出来事を別視点で保存 | duo-talk独自の発明 |

### 2.3 メモリエントリ構造

```yaml
event_id: "uuid-xxx"
timestamp: "2026-01-08T12:00:00Z"
event_summary: "カーブでスピン発生"

yana_perspective: |
  やっぱり攻めすぎたかな...でも限界知れてよかった

ayu_perspective: |
  姉様の進入速度は推奨値を15%超過していました

emotional_tag: "failure_learning"
context_tags: ["curve", "speed", "spin"]
```

### 2.4 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    SisterMemory システム                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                 Memory Store (SQLite/JSON)                │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ event_id | timestamp | summary | yana | ayu | tags  │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                 │
│              ┌───────────────┴───────────────┐                │
│              │                               │                │
│              ▼                               ▼                │
│     ┌─────────────────┐             ┌─────────────────┐      │
│     │  MemoryReader   │             │  MemoryWriter   │      │
│     │  (走行中)       │             │  (走行後)       │      │
│     └─────────────────┘             └─────────────────┘      │
│              │                               │                │
│              ▼                               ▼                │
│     ┌─────────────────┐             ┌─────────────────┐      │
│     │ PromptInjector  │             │ PerspectiveFilter│     │
│     └─────────────────┘             └─────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

### 2.5 実装予定

- `src/sister_memory.py` - メモリ管理
- `src/memory_reader.py` - 検索・読み出し
- `src/memory_writer.py` - 書き込み・フィルタ
- `src/perspective_filter.py` - キャラ崩壊防止フィルタ

---

## 3. 音声合成統合

### 3.1 概要

VOICEVOX / COEIROINK との統合による音声出力。

### 3.2 要件

- キャラクター別の声色設定
- 感情に応じたトーン変化
- リアルタイム生成

### 3.3 実装予定

- `src/tts_client.py` - TTS APIクライアント
- `config/voice_settings.yaml` - 声色設定

---

## 4. 視聴者コメント連携

### 4.1 概要

YouTube Live / Twitch のコメントを取り込み、対話に反映。

### 4.2 要件

- コメントのフィルタリング（不適切発言除外）
- コメントの要約・グルーピング
- キャラクターがコメントに反応

### 4.3 実装予定

- `src/comment_fetcher.py` - コメント取得
- `src/comment_filter.py` - フィルタリング
- DuoSignals への viewer_comments イベント追加
